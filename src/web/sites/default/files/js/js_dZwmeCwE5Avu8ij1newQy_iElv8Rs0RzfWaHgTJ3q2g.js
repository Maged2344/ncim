/* @license GPL-2.0-or-later https://www.drupal.org/licensing/faq */
(function($,Drupal){'use strict';Drupal.behaviors.pageFeedback={attach:function(context,settings){this.initFeedbackForm(context);},initFeedbackForm:function(context){const $context=$(context);const $positiveBtn=$context.find('#positiveFeedbackBtn');const $negativeBtn=$context.find('#negativeFeedbackBtn');const $closeBtn=$context.find('#closeFeedbackBtn');const $feedbackCollapse=$context.find('#feedback');const $form=$context.find('#feedbackForm');const $submitBtn=$context.find('button[type="submit"]');let feedbackType='';let selectedReasons=[];let selectedGender='';let userComment='';$positiveBtn.on('click',function(){feedbackType='positive';selectedReasons=[];selectedGender='';userComment='';$positiveBtn.text('شكراً لك!').prop('disabled',true);$negativeBtn.hide();submitFeedback();});$negativeBtn.on('click',function(){feedbackType='negative';$feedbackCollapse.collapse('show');$negativeBtn.hide();$closeBtn.removeClass('d-none');});$closeBtn.on('click',function(){$feedbackCollapse.collapse('hide');$negativeBtn.show();$closeBtn.addClass('d-none');feedbackType='';});$context.find('.reason-checkbox').on('change',function(){const value=$(this).val();if($(this).is(':checked')){selectedReasons.push(value);const $feedbackErrorDiv=$context.find('.invalid-feedback').first();$feedbackErrorDiv.removeClass('d-block');}else selectedReasons=selectedReasons.filter((reason)=>reason!==value);});$context.find('input[name="gender"]').on('change',function(){selectedGender=$(this).val();console.log('Gender selected:',selectedGender);const $errorDivs=$context.find('.invalid-feedback');const $genderErrorDiv=$errorDivs.eq(1);$genderErrorDiv.removeClass('d-block');});$context.find('#comment').on('input',function(){userComment=$(this).val();});$form.on('submit',function(e){e.preventDefault();handleFormSubmission();});$context.on('click','button[type="submit"]',function(e){e.preventDefault();handleFormSubmission();});function handleFormSubmission(){console.log('=== FORM SUBMISSION ATTEMPT ===');console.log('feedbackType:',feedbackType);console.log('selectedReasons:',selectedReasons);console.log('selectedGender:',selectedGender);if(feedbackType==='negative'){if(selectedReasons.length===0){console.log('Validation failed: No reasons selected');showFeedbackReasonsError(Drupal.t('الرجاء تحديد سبب واحد على الأقل'));return;}if(!selectedGender){console.log('Validation failed: No gender selected');showGenderError(Drupal.t('الرجاء تحديد تقييم'));return;}}console.log('Validation passed, submitting feedback...');submitFeedback();}function submitFeedback(){const formData=new FormData();formData.append('feedback_type',feedbackType);formData.append('feedback_reasons',selectedReasons.join(', '));formData.append('gender',selectedGender);formData.append('comment',userComment);formData.append('page_url',window.location.pathname);formData.append('page_title',document.title);$.ajax({url:Drupal.url('feedback/submit'),type:'POST',data:formData,processData:false,contentType:false,success:function(response){if(response.success){showSuccessMessage(Drupal.t('شكراً لك على ملاحظاتك!'));resetForm();}else showErrorMessage(Drupal.t('حدث خطأ أثناء إرسال الملاحظات. يرجى المحاولة مرة أخرى.'));},error:function(){showErrorMessage(Drupal.t('حدث خطأ أثناء إرسال الملاحظات. يرجى المحاولة مرة أخرى.'));}});}function showFeedbackReasonsError(message){console.log('Showing feedback reasons error:',message);const $errorDiv=$context.find('.invalid-feedback').first();if($errorDiv.length>0){$errorDiv.text(message).addClass('d-block');console.log('Feedback reasons error div updated and shown');}else console.log('No feedback reasons error div found');setTimeout(function(){$errorDiv.removeClass('d-block');},5000);}function showGenderError(message){console.log('Showing gender error:',message);const $errorDivs=$context.find('.invalid-feedback');const $genderErrorDiv=$errorDivs.eq(1);if($genderErrorDiv.length>0){$genderErrorDiv.text(message).addClass('d-block');console.log('Gender error div updated and shown');}else console.log('No gender error div found');setTimeout(function(){$genderErrorDiv.removeClass('d-block');},5000);}function showSuccessMessage(message){const $successDiv=$('<div class="alert alert-success mt-3">'+message+'</div>');$form.after($successDiv);setTimeout(function(){$successDiv.fadeOut();},5000);}function showErrorMessage(message){const $errorDiv=$('<div class="alert alert-danger mt-3">'+message+'</div>');$form.after($errorDiv);setTimeout(function(){$errorDiv.fadeOut();},5000);}function resetForm(){$feedbackCollapse.collapse('hide');$positiveBtn.text('نعم').prop('disabled',false);$negativeBtn.show();$closeBtn.addClass('d-none');$form[0].reset();feedbackType='';selectedReasons=[];selectedGender='';userComment='';}}};})(jQuery,Drupal);;
